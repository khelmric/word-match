<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordMatch</title>
    <link rel="icon" type="image/x-icon" href="static/img/favicon.ico">
    <link rel="stylesheet" href="static/style.css">
</head>
<body>

<!-- ================= TOP MENU ================= -->
<div id="topLeftMenu">
    <a class="topMenuButton" title="Kezd≈ëlap" onclick="goHome()">üè†</a>
    <a id="openSettingsBtn" class="topMenuButton" title="Be√°ll√≠t√°sok">üõ†</a>

    <div id="langBtn" class="lang-dropdown">
        <a class="topMenuButton">
            <img src="static/img/flaghu.png" width="20" height="20">
        </a>
        <div class="lang-dropdown-content">
            <a data-lang="hu"><img src="static/img/flaghu.png" width="20" height="20"> Magyar</a>
        </div>
    </div>

    <a id="shareUrlBtn" class="topMenuButton" title="Link m√°sol√°sa"
       onclick="navigator.clipboard.writeText(window.location.href)">üìã</a>
</div>

<!-- ================= TITLE ================= -->
<div id="gameTitle">
    <h1>
        <div id="titleText1" title="v1.2">Word</div>
        <div id="titleText2" title="v1.2">matcH</div>
    </h1>
    <div id="openingItems">
        <img src="static/img/title.png" height="180"><br>
        <h3 class="titleText">TAL√ÅLD MEG A P√ÅROKAT</h3>
    </div>
</div>

<!-- ================= SETTINGS POPUP ================= -->
<div id="settingsPopup" class="popup">
    <div style="float:right">
        <a class="topMenuButton" title="Reset" onclick="resetSettings()">‚Ü∫</a>
        <a class="topMenuButton" title="K√°v√© ‚òï" href="https://buymeacoffee.com/khelmric">‚òï</a>
    </div>

    <div class="popup-header">Be√°ll√≠t√°sok</div>
    <div class="popup-body">
        <form id="settingsForm">
            <label>Max sz√≥tag:</label>
            <select id="syllables" name="syllables">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="100" selected>5+</option>
            </select>

            <br><br>
            <label>Sz√ºks√©ges bet≈±k:</label><br>
            <select id="includeChar1" name="includeChar1" class="include-char-dropdown"></select>
            <select id="includeChar2" name="includeChar2" class="include-char-dropdown"></select>
            <select id="includeChar3" name="includeChar3" class="include-char-dropdown"></select>

            <br><br>
            <label>Kiz√°rand√≥ bet≈±k:</label>
            <div id="excludeCharsContainer"></div>

            <br><br>
            <label>Visszasz√°ml√°l√≥:</label>
            <input id="counter" name="counter" type="number" value="20" min="5" max="99"> s

            <br><br>
            <button class="bigButton" type="button" onclick="submitSettings()">OK</button>
        </form>
    </div>
</div>

<!-- ================= GAME HEADER ================= -->
<div id="header">
    <div id="countdown" class="hidden">0</div>
    <div id="status" class="hidden">
        <span id="lives"></span>
        <span id="level">1. szint</span>
    </div>
</div>

<!-- ================= CONTROLS ================= -->
<div id="controls">
    <button id="startButton">Start</button>
    <button id="stopButton" class="hidden">Stop</button>
</div>

<!-- ================= GAME ================= -->
<div id="game" class="hidden">
    <div class="card" id="card1"></div>
    <div class="card" id="card2"></div>
</div>

<div id="message"></div>

<!-- ================= SCRIPT ================= -->
<script>
/* ---------- DEFAULTS ---------- */
const settingsState = {
    syllables: 100,   // default = 5+
    counter: 20
};
/* ---------- DOM CACHE ---------- */
const dom = {
    start: document.getElementById("startButton"),
    stop: document.getElementById("stopButton"),
    openSettingsBtn: document.getElementById("openSettingsBtn"),
    langBtn: document.getElementById("langBtn"),
    shareUrlBtn: document.getElementById("shareUrlBtn"),
    openingItems: document.getElementById("openingItems"),
    card1: document.getElementById("card1"),
    card2: document.getElementById("card2"),
    level: document.getElementById("level"),
    lives: document.getElementById("lives"),
    countdown: document.getElementById("countdown"),
    message: document.getElementById("message"),
    syllables: document.getElementById("syllables"),
    counter: document.getElementById("counter"),
    settingsPopup: document.getElementById("settingsPopup")
};

/* ---------- LANGUAGE ---------- */
let lang = localStorage.getItem("lang")?.trim() || "hu";
localStorage.setItem("lang", lang);

/* ---------- GAME STATE ---------- */
let words = [];
let includedChars = [];
let excludedChars = [];
let lives = 5;
let level = 1;
let levelJump = 5;
let wordCount = 4;
let roundTimer;

/* ---------- LETTERS ---------- */
const letters = [
    { letter:"a",id:"a" },{ letter:"√°",id:"aa" },{ letter:"b",id:"b" },
    { letter:"c",id:"c" },{ letter:"cs",id:"cs" },{ letter:"d",id:"d" },
    { letter:"dz",id:"dz" },{ letter:"dzs",id:"dzs" },{ letter:"e",id:"e" },
    { letter:"√©",id:"ee" },{ letter:"f",id:"f" },{ letter:"g",id:"g" },
    { letter:"gy",id:"gy" },{ letter:"h",id:"h" },{ letter:"i",id:"i" },
    { letter:"√≠",id:"ii" },{ letter:"j",id:"j" },{ letter:"k",id:"k" },
    { letter:"l",id:"l" },{ letter:"ly",id:"ly" },{ letter:"m",id:"m" },
    { letter:"n",id:"n" },{ letter:"ny",id:"ny" },{ letter:"o",id:"o" },
    { letter:"√≥",id:"oo" },{ letter:"√∂",id:"oe" },{ letter:"≈ë",id:"ooe" },
    { letter:"p",id:"p" },{ letter:"q",id:"q" },{ letter:"r",id:"r" },
    { letter:"s",id:"s" },{ letter:"sz",id:"sz" },{ letter:"t",id:"t" },
    { letter:"ty",id:"ty" },{ letter:"u",id:"u" },{ letter:"√∫",id:"uu" },
    { letter:"√º",id:"ue" },{ letter:"≈±",id:"uue" },{ letter:"v",id:"v" },
    { letter:"w",id:"w" },{ letter:"x",id:"x" },{ letter:"y",id:"y" },
    { letter:"z",id:"z" },{ letter:"zs",id:"zs" }
];

/* ---------- INIT UI ---------- */
document.querySelectorAll(".include-char-dropdown").forEach(dd => {
    dd.appendChild(new Option("", ""));
    letters.forEach(l => dd.appendChild(new Option(l.letter, l.letter)));
});

const excludeContainer = document.getElementById("excludeCharsContainer");
letters.forEach(l => {
    const label = document.createElement("label");
    label.className = "nowrap";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.id = `exclude_${l.id}`;
    cb.name = cb.id;
    label.append(cb, l.letter);
    excludeContainer.appendChild(label);
});

/* ---------- FILE LOAD ---------- */
async function loadFile(lang){
    const res = await fetch(`static/txt/words-${lang}.txt`);
    const txt = await res.text();
    words = txt.split("\n").map(w=>w.trim()).filter(Boolean);
}
loadFile(lang);

/* ---------- GAME LOGIC ---------- */
function toggleItems(){
    ["start","stop","openingItems","openSettingsBtn","langBtn","shareUrlBtn"].forEach(k=>dom[k].classList.toggle("hidden"));
    ["status","countdown","game"].forEach(id=>document.getElementById(id).classList.toggle("hidden"));
}

function startGame(){
    lives=5; level=1; wordCount=4; levelJump=5;
    dom.lives.textContent=getLives(lives);
    dom.level.textContent="1. szint";
    toggleItems(); resetGame();
}

function stopGame(){
    clearInterval(roundTimer);
    toggleItems();
    alert(`üõë J√°t√©k meg√°ll√≠tva. El√©rt szint: ${level}`);
}

function resetGame(){
    clearInterval(roundTimer);
    dom.card1.innerHTML=dom.card2.innerHTML="";
    const picks=getUniqueWords(words,wordCount*2-1);
    if(!picks) return;
    const common=picks[0];
    const others=picks.slice(1);
    render(dom.card1,shuffle([...others.slice(0,wordCount-1),common]));
    render(dom.card2,shuffle([...others.slice(wordCount-1),common]));
    startTimer(common);
}

function startTimer(common){
    let t=Number(dom.counter.value);
    dom.countdown.textContent=t;
    roundTimer=setInterval(()=>{
        dom.countdown.textContent=--t;
        if(t<=0){ clearInterval(roundTimer); fail(); }
    },1000);

    function fail(){
        if(--lives<=0){
            toggleItems();
            alert(`‚ò†Ô∏è J√°t√©k v√©ge. El√©rt szint: ${level}`);
        }else{
            dom.lives.textContent=getLives(lives);
            resetGame();
        }
    }
}

function render(card,arr){
    arr.forEach(w=>{
        const d=document.createElement("div");
        d.textContent=w;
        d.className="word";
        d.onclick=()=>pick(w);
        card.appendChild(d);
    });
}

function pick(word){
    clearInterval(roundTimer);
    if(dom.card1.textContent.includes(word)&&dom.card2.textContent.includes(word)){
        if(--levelJump===0){ level++; wordCount++; levelJump=5; }
        dom.level.textContent=`${level}. szint`;
        resetGame();
    }else{
        if(--lives<=0){
            toggleItems();
            alert(`‚ò†Ô∏è J√°t√©k v√©ge. El√©rt szint: ${level}`);
        }else{
            dom.lives.textContent=getLives(lives);
            resetGame();
        }
    }
}

/* ---------- HELPERS ---------- */
const shuffle=a=>a.sort(()=>Math.random()-0.5);
const getLives=n=>"üñ§".repeat(5-n)+"üíö".repeat(n);

function getUniqueWords(arr,c){
    const max=Number(dom.syllables.value);
    return shuffle(arr.filter(w=>countSyllables(w)<=max)).slice(0,c);
}

function countSyllables(w){
    return (w.match(/[a√°e√©i√≠o√≥√∂≈ëu√∫√º≈±]/gi)||[]).length||1;
}

/* ---------- SETTINGS ---------- */
document.getElementById("openSettingsBtn").onclick = () => {
    const isOpen = dom.settingsPopup.classList.toggle("active");
    // hide Start when settings is open
    dom.start.classList.toggle("hidden", isOpen);
};
function submitSettings(){
    const p=new URLSearchParams(new FormData(settingsForm));
    location.href=`${location.pathname}?${p}`;
}
function resetSettings(){ location.href=location.pathname; }
function goHome(){ location.reload(); }

/* ---------- EVENTS ---------- */
dom.start.onclick=startGame;
dom.stop.onclick=stopGame;
</script>

</body>
</html>