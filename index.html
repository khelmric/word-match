<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordMatch</title>
    <link rel="icon" type="image/x-icon" href="static/img/favicon.png">
    <link rel="stylesheet" href="static/style.css">
</head>
<body>

<!-- ================= TOP MENU ================= -->
<div id="topLeftMenu">
    <a class="topMenuButton" title="Kezd≈ëlap" onclick="goHome()">üè†</a>
    <a id="openSettingsBtn" class="topMenuButton" title="Be√°ll√≠t√°sok">üõ†</a>

    <div id="langBtn" class="lang-dropdown">
        <a class="topMenuButton">
            <img id="currentFlag" src="static/img/flaghu.png" width="20" height="20">
        </a>
        <div class="lang-dropdown-content">
            <a data-lang="hu"><img src="static/img/flaghu.png" width="20"> Magyar</a>
            <a data-lang="en"><img src="static/img/flagen.png" width="20"> English</a>
            <a data-lang="de"><img src="static/img/flagde.png" width="20"> Deutsch</a>
            <a data-lang="symbols" style="font-size: 1.5em;"><img src="static/img/flagsymbols.png" width="20"> 
                <span style="color: red;">‚ñ†</span><span style="color: purple;">‚ú≠</span><span style="color: blue;">‚óè</span><span style="color: green;">‚ñ≤</span>
            </a>
            <a data-lang="nature"><img src="static/img/flagnature.png" width="20"> üê¢ü¶Üüêûü¶à</a>
        </div>
    </div>

    <a id="shareUrlBtn" class="topMenuButton" title=""
       onclick="navigator.clipboard.writeText(window.location.href)">üìã</a>
</div>

<!-- ================= TITLE ================= -->
<div id="gameTitle">
    <h1>
        <div id="titleText1" title="v1.2">Word</div>
        <div id="titleText2" title="v1.2">matcH</div>
    </h1>
    <div id="openingItems">
        <img src="static/img/title.png" height="180"><br>
        <h3 id="subtitle" class="titleText"></h3>
    </div>
</div>

<!-- ================= SETTINGS POPUP ================= -->
<div id="settingsPopup" class="popup">
    <div style="float:right">
        <a class="topMenuButton" title="Reset" onclick="resetSettings()">‚Ü∫</a>
        <a class="topMenuButton" title="K√°v√© ‚òï" href="https://buymeacoffee.com/khelmric">‚òï</a>
    </div>

    <div id="settingsTitle" class="popup-header"></div>
    <div class="popup-body">
        <form id="settingsForm">
            <label id="lblSyllables"></label>
            <select id="syllables" name="syllables">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="100" selected>5+</option>
            </select>

            <br><br>
            <label id="lblInclude"></label><br>
            <select id="includeChar1" name="includeChar1" class="include-char-dropdown"></select>
            <select id="includeChar2" name="includeChar2" class="include-char-dropdown"></select>
            <select id="includeChar3" name="includeChar3" class="include-char-dropdown"></select>

            <br><br>
            <label id="lblExclude"></label>
            <div id="excludeCharsContainer"></div>

            <br><br>
            <label id="lblTimer"></label>
            <input id="counter" name="counter" type="number" value="20" min="5" max="99"> s

            <br><br>
            <button id="btnOk" class="bigButton" type="button" onclick="submitSettings()"></button>
        </form>
    </div>
</div>

<!-- ================= GAME HEADER ================= -->
<div id="header">
    <div id="countdown" class="hidden">0</div>
    <div id="status" class="hidden">
        <span id="lives"></span>
        <span id="level"></span>
    </div>
</div>

<!-- ================= CONTROLS ================= -->
<div id="controls">
    <button id="startButton"></button>
    <button id="stopButton" class="hidden"></button>
</div>

<!-- ================= GAME ================= -->
<div id="game" class="hidden">
    <div class="card" id="card1"></div>
    <div class="card" id="card2"></div>
</div>

<div id="message"></div>

<!-- ================= SCRIPT ================= -->
<script>
/* ---------- DEFAULTS ---------- */
const settingsState = {
    syllables: 100,   // default = 5+
    counter: 20
};
/* ---------- LANGUAGE DATA ---------- */
const BASE_SYMBOLS = {
    subtitle: "",
    settings: "",
    syllables: "",
    include: "",
    exclude: "",
    timer: "",
    ok: "OK",
    start: "Start",
    stop: "Stop",
    level: n => `Level ${n}`,
    stopped: lvl => `üõë Game stopped. Reached level: ${lvl}`,
    gameover: lvl => `üèÜ Game over. Reached level: ${lvl}`
};
const i18n = {
    hu: {
        subtitle: "TAL√ÅLD MEG A P√ÅROKAT",
        settings: "Be√°ll√≠t√°sok",
        syllables: "Max sz√≥tag:",
        include: "Sz√ºks√©ges bet≈±k:",
        exclude: "Kiz√°rand√≥ bet≈±k:",
        timer: "Visszasz√°ml√°l√≥:",
        ok: "OK",
        start: "Start",
        stop: "Stop",
        level: n => `${n}. szint`,
        stopped: lvl => `üõë J√°t√©k meg√°ll√≠tva. El√©rt szint: ${lvl}`,
        gameover: lvl => `üèÜ J√°t√©k v√©ge. El√©rt szint: ${lvl}`
    },
    en: {
        subtitle: "FIND THE PAIRS",
        settings: "Settings",
        syllables: "Max syllables:",
        include: "Required letters:",
        exclude: "Excluded letters:",
        timer: "Countdown:",
        ok: "OK",
        start: "Start",
        stop: "Stop",
        level: n => `Level ${n}`,
        stopped: lvl => `üõë Game stopped. Reached level: ${lvl}`,
        gameover: lvl => `üèÜ Game over. Reached level: ${lvl}`
    },
    de: {
        subtitle: "FINDE DIE PAARE",
        settings: "Einstellungen",
        syllables: "Max. Silben:",
        include: "Erforderliche Buchstaben:",
        exclude: "Ausgeschlossene Buchstaben:",
        timer: "Countdown:",
        ok: "OK",
        start: "Start",
        stop: "Stop",
        level: n => `Level ${n}`,
        stopped: lvl => `üõë Spiel gestoppt. Erreichtes Level: ${lvl}`,
        gameover: lvl => `üèÜ Spiel vorbei. Erreichtes Level: ${lvl}`
    },
    symbols: BASE_SYMBOLS,
    nature: BASE_SYMBOLS
};
/* ---------- DOM CACHE ---------- */
const dom = {
    start: document.getElementById("startButton"),
    stop: document.getElementById("stopButton"),
    openSettingsBtn: document.getElementById("openSettingsBtn"),
    langBtn: document.getElementById("langBtn"),
    shareUrlBtn: document.getElementById("shareUrlBtn"),
    openingItems: document.getElementById("openingItems"),
    card1: document.getElementById("card1"),
    card2: document.getElementById("card2"),
    level: document.getElementById("level"),
    lives: document.getElementById("lives"),
    countdown: document.getElementById("countdown"),
    message: document.getElementById("message"),
    syllables: document.getElementById("syllables"),
    counter: document.getElementById("counter"),
    settingsPopup: document.getElementById("settingsPopup")
};

/* ---------- LANGUAGE INIT ---------- */
let lang = localStorage.getItem("lang")?.trim() || "hu";
document.documentElement.lang = lang;
localStorage.setItem("lang", lang);
toggleSettings();

/* ---------- APPLY LANGUAGE ---------- */
function applyLang() {
    const t = i18n[lang];
    subtitle.textContent = t.subtitle;
    settingsTitle.textContent = t.settings;
    lblSyllables.textContent = t.syllables;
    lblInclude.textContent = t.include;
    lblExclude.textContent = t.exclude;
    lblTimer.textContent = t.timer;
    btnOk.textContent = t.ok;
    startButton.textContent = t.start;
    stopButton.textContent = t.stop;
    level.textContent = t.level(1);
    currentFlag.src = `static/img/flag${lang}.png`;
}

/* ---------- LANGUAGE SWITCH ---------- */
document.querySelectorAll(".lang-dropdown-content a").forEach(a => {
    a.onclick = async () => {
        lang = a.dataset.lang;
        localStorage.setItem("lang", lang);

        await loadFile(lang);
        applyLang();

        toggleSettings();
        buildSettingsUI();   // rebuild letters for new language
        resetSettingsUI();   // reset everything
        goHome();
    };
});

/* ---------- GAME STATE ---------- */
let words = [];
let includedChars = [];
let excludedChars = [];
let lives = 5;
let level = 1;
let levelJump = 5;
let wordCount = 4;
let roundTimer;

/* ---------- LETTERS ---------- */
const LETTER_SETS = {
    hu: [
        { letter:"a",id:"a" },{ letter:"√°",id:"aa" },{ letter:"b",id:"b" },
        { letter:"c",id:"c" },{ letter:"cs",id:"cs" },{ letter:"d",id:"d" },
        { letter:"dz",id:"dz" },{ letter:"dzs",id:"dzs" },{ letter:"e",id:"e" },
        { letter:"√©",id:"ee" },{ letter:"f",id:"f" },{ letter:"g",id:"g" },
        { letter:"gy",id:"gy" },{ letter:"h",id:"h" },{ letter:"i",id:"i" },
        { letter:"√≠",id:"ii" },{ letter:"j",id:"j" },{ letter:"k",id:"k" },
        { letter:"l",id:"l" },{ letter:"ly",id:"ly" },{ letter:"m",id:"m" },
        { letter:"n",id:"n" },{ letter:"ny",id:"ny" },{ letter:"o",id:"o" },
        { letter:"√≥",id:"oo" },{ letter:"√∂",id:"oe" },{ letter:"≈ë",id:"ooe" },
        { letter:"p",id:"p" },{ letter:"r",id:"r" },
        { letter:"s",id:"s" },{ letter:"sz",id:"sz" },{ letter:"t",id:"t" },
        { letter:"ty",id:"ty" },{ letter:"u",id:"u" },{ letter:"√∫",id:"uu" },
        { letter:"√º",id:"ue" },{ letter:"≈±",id:"uue" },{ letter:"v",id:"v" },
        { letter:"z",id:"z" },{ letter:"zs",id:"zs" }
    ],

    en: [
        { letter:"a",id:"a" },{ letter:"b",id:"b" },{ letter:"c",id:"c" },
        { letter:"d",id:"d" },{ letter:"e",id:"e" },{ letter:"f",id:"f" },
        { letter:"g",id:"g" },{ letter:"h",id:"h" },{ letter:"i",id:"i" },
        { letter:"j",id:"j" },{ letter:"k",id:"k" },{ letter:"l",id:"l" },
        { letter:"m",id:"m" },{ letter:"n",id:"n" },{ letter:"o",id:"o" },
        { letter:"p",id:"p" },{ letter:"q",id:"q" },{ letter:"r",id:"r" },
        { letter:"s",id:"s" },{ letter:"t",id:"t" },{ letter:"u",id:"u" },
        { letter:"v",id:"v" },{ letter:"w",id:"w" },{ letter:"x",id:"x" },
        { letter:"y",id:"y" },{ letter:"z",id:"z" }
    ],

    de: [
        { letter:"a",id:"a" },{ letter:"√§",id:"ae" },
        { letter:"b",id:"b" },
        { letter:"c",id:"c" },
        { letter:"d",id:"d" },
        { letter:"e",id:"e" },
        { letter:"f",id:"f" },
        { letter:"g",id:"g" },
        { letter:"h",id:"h" },
        { letter:"i",id:"i" },
        { letter:"j",id:"j" },
        { letter:"k",id:"k" },
        { letter:"l",id:"l" },
        { letter:"m",id:"m" },
        { letter:"n",id:"n" },
        { letter:"o",id:"o" },{ letter:"√∂",id:"oe" },
        { letter:"p",id:"p" },
        { letter:"q",id:"q" },
        { letter:"r",id:"r" },
        { letter:"s",id:"s" },{ letter:"√ü",id:"ss" },
        { letter:"t",id:"t" },
        { letter:"u",id:"u" },{ letter:"√º",id:"ue" },
        { letter:"v",id:"v" },
        { letter:"w",id:"w" },
        { letter:"x",id:"x" },
        { letter:"y",id:"y" },
        { letter:"z",id:"z" }
    ]
};

const letters = LETTER_SETS[lang] || LETTER_SETS.hu;

/* ---------- INIT UI ---------- */
document.querySelectorAll(".include-char-dropdown").forEach(dd => {
    dd.appendChild(new Option("", ""));
    letters.forEach(l => dd.appendChild(new Option(l.letter, l.letter)));
});

const excludeContainer = document.getElementById("excludeCharsContainer");
letters.forEach(l => {
    const label = document.createElement("label");
    label.className = "nowrap";
    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.id = `exclude_${l.id}`;
    cb.name = cb.id;
    label.append(cb, l.letter);
    excludeContainer.appendChild(label);
});

/* ---------- APPLY URL SETTINGS ---------- */
function applySettingsFromUrl() {
    const params = new URLSearchParams(location.search);

    // syllables
    if (params.has("syllables")) {
        dom.syllables.value = params.get("syllables");
    }

    // counter
    if (params.has("counter")) {
        dom.counter.value = params.get("counter");
    }

    // include chars
    ["includeChar1", "includeChar2", "includeChar3"].forEach(id => {
        if (params.has(id)) {
            const el = document.getElementById(id);
            el.value = params.get(id) || "";
        }
    });

    // exclude chars
    letters.forEach(l => {
        const key = `exclude_${l.id}`;
        if (params.has(key)) {
            const cb = document.getElementById(key);
            if (cb) cb.checked = true;
        }
    });
}

function rebuildCharFilters() {
    includedChars = [];
    excludedChars = [];

    // includes
    ["includeChar1", "includeChar2", "includeChar3"].forEach(id => {
        const v = document.getElementById(id).value;
        if (v) includedChars.push(v);
    });

    // excludes
    letters.forEach(l => {
        const cb = document.getElementById(`exclude_${l.id}`);
        if (cb?.checked) excludedChars.push(l.letter);
    });
}



/* ---------- FILE LOAD ---------- */
async function loadFile(lang){
    const res = await fetch(`static/txt/list-${lang}.txt`);
    const txt = await res.text();
    words = txt.split("\n").map(w=>w.trim()).filter(Boolean);
}

applyLang();
applySettingsFromUrl();
loadFile(lang);

/* ---------- GAME LOGIC ---------- */
function toggleItems(hide){
    if (hide === true ) {
        ["start","openingItems","openSettingsBtn","langBtn","shareUrlBtn"].forEach(k=>dom[k].classList.add("hidden"));
        ["stop"].forEach(k=>dom[k].classList.remove("hidden"));
        ["status","countdown","game"].forEach(id=>document.getElementById(id).classList.remove("hidden"));
    } else {
        ["start","openingItems","openSettingsBtn","langBtn","shareUrlBtn"].forEach(k=>dom[k].classList.remove("hidden"));
        ["stop"].forEach(k=>dom[k].classList.add("hidden"));
        ["status","countdown","game"].forEach(id=>document.getElementById(id).classList.add("hidden"));
        toggleSettings();
    }
}

function startGame(){
    lives=5; level=1; wordCount=4; levelJump=5;
    dom.lives.textContent=getLives(lives);
    dom.level.textContent=i18n[lang].level(level);
    toggleItems(true); resetGame();
}

function stopGame(){
    clearInterval(roundTimer);
    toggleItems(false);
    alert(i18n[lang].stopped(level));
}

function resetGame(){
    clearInterval(roundTimer);
    dom.card1.innerHTML=dom.card2.innerHTML="";
    const picks=getUniqueWords(words,wordCount*2-1);
    if(!picks) return;
    const common=picks[0];
    const others=picks.slice(1);
    render(dom.card1,shuffle([...others.slice(0,wordCount-1),common]));
    render(dom.card2,shuffle([...others.slice(wordCount-1),common]));
    startTimer(common);
}

function startTimer(common){
    let t=Number(dom.counter.value);
    dom.countdown.textContent=t;
    roundTimer=setInterval(()=>{
        dom.countdown.textContent=--t;
        if(t<=0){ clearInterval(roundTimer); fail(); }
    },1000);

    function fail(){
        if(--lives<=0){
            toggleItems(false);
            alert(i18n[lang].gameover(level));
        }else{
            dom.lives.textContent=getLives(lives);
            resetGame();
        }
    }
}

function render(card,arr){
    arr.forEach(w=>{
        const d=document.createElement("div");
        d.textContent=w;
        d.className="word";
        if (lang === "symbols" || lang === "nature") { 
            d.style.color = getRandomColor("3456789ABC");
            d.style.fontSize = `${Math.floor(Math.random() * 30) + 40}px`;
            d.style.fontFamily = getRandomFont();
        } else {
            d.style.color = getRandomColor("0123456789ABCD");
            d.style.fontSize = `${Math.floor(Math.random() * 20) + 20}px`;
            d.style.fontFamily = getRandomFont();
        }
        d.onclick=()=>pick(w);
        card.appendChild(d);
    });
}

function pick(word){
    clearInterval(roundTimer);
    if(dom.card1.textContent.includes(word)&&dom.card2.textContent.includes(word)){
        if(--levelJump===0){ level++; wordCount++; levelJump=5; }
        dom.level.textContent = i18n[lang].level(level);
        resetGame();
    }else{
        if(--lives<=0){
            toggleItems(false);
            alert(i18n[lang].gameover(level));
        }else{
            dom.lives.textContent=getLives(lives);
            resetGame();
        }
    }
}

/* ---------- HELPERS ---------- */
const shuffle=a=>a.sort(()=>Math.random()-0.5);
const getLives=n=>"üñ§".repeat(5-n)+"üíö".repeat(n);

function getUniqueWords(arr, c) {
    rebuildCharFilters();

    const max = Number(dom.syllables.value);

    return shuffle(
        arr.filter(w => {
            // syllables
            if (countSyllables(w) > max) return false;

            // include chars
            for (const ch of includedChars) {
                if (!w.includes(ch)) return false;
            }

            // exclude chars
            for (const ch of excludedChars) {
                if (w.includes(ch)) return false;
            }

            return true;
        })
    ).slice(0, c);
}

function countSyllables(w){
    // HU
    if (lang === "hu") { 
        return (w.match(/[a√°e√©i√≠o√≥√∂≈ëu√∫√º≈±]/gi)||[]).length||1;
    }
    // DE
    if (lang === "de") {
        return (w.match(/[aeiouy√§√∂√º]/gi) || []).length || 1;
    }
    // EN
    return (w.match(/[aeiouy]/gi) || []).length || 1;

}

function getRandomColor(colorLetters) {
    let color = "#";
    for (let i = 0; i < 6; i++) {
        color += colorLetters[
            Math.floor(Math.random() * colorLetters.length)
        ];
    }
    return color;
}

function getRandomFont() {
    const fonts = ["Arial", "Verdana", "Times New Roman", "Courier New", "Georgia"];
    return fonts[Math.floor(Math.random() * fonts.length)];
}

function getInitialLang() {
    const params = new URLSearchParams(location.search);

    if (params.has("lang")) {
        const l = params.get("lang");
        localStorage.setItem("lang", l);
        return l;
    }

    return localStorage.getItem("lang") || "hu";
}

let lang = getInitialLang();
document.documentElement.lang = lang;

/* ---------- SETTINGS ---------- */
document.getElementById("openSettingsBtn").onclick = () => {
    const isOpen = dom.settingsPopup.classList.toggle("active");
    // hide Start when settings is open
    dom.start.classList.toggle("hidden", isOpen);
};
function submitSettings(){
    const p=new URLSearchParams(new FormData(settingsForm));
    location.href=`${location.pathname}?${p}`;
}
function resetSettings(){ location.href=location.pathname; }
function goHome(){ 
    window.location.replace(window.location.pathname);
}

/* ---------- RESET SETTINGS ---------- */
function resetSettingsUI() {
    // defaults
    dom.syllables.value = 100;   // 5+
    dom.counter.value = 20;

    // clear include dropdowns
    document.querySelectorAll(".include-char-dropdown")
        .forEach(dd => dd.value = "");

    // uncheck all exclude checkboxes
    document.querySelectorAll("#excludeCharsContainer input[type=checkbox]")
        .forEach(cb => cb.checked = false);
}

function buildSettingsUI() {
    // ---------- INCLUDE DROPDOWNS ----------
    document.querySelectorAll(".include-char-dropdown").forEach(dd => {
        dd.innerHTML = "";
        dd.appendChild(new Option("", ""));
        LETTER_SETS[lang].forEach(l =>
            dd.appendChild(new Option(l.letter, l.letter))
        );
    });

    // ---------- EXCLUDE CHECKBOXES ----------
    const excludeContainer = document.getElementById("excludeCharsContainer");
    excludeContainer.innerHTML = "";

    LETTER_SETS[lang].forEach(l => {
        const label = document.createElement("label");
        label.className = "nowrap";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.id = `exclude_${l.id}`;
        cb.name = cb.id;

        label.append(cb, l.letter);
        excludeContainer.appendChild(label);
    });
}

/* ---------- TOGGLE SETTINGS ---------- */
function toggleSettings() {
    if (lang === "symbols" || lang === "nature") { 
        document.getElementById("openSettingsBtn").classList.add("hidden");
    } else {
        document.getElementById("openSettingsBtn").classList.remove("hidden");
    }
}

/* ---------- EVENTS ---------- */
dom.start.onclick=startGame;
dom.stop.onclick=stopGame;
</script>

</body>
</html>